---
phase: 03-type-generation-and-first-resource
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/client.ts
  - tests/client.test.ts
autonomous: true

must_haves:
  truths:
    - "AgentOSClient.request() is protected so resource classes can access it"
    - "request() handles FormData bodies by removing Content-Type header"
  artifacts:
    - path: "src/client.ts"
      provides: "AgentOSClient with protected request() method"
      contains: "protected async request"
  key_links:
    - from: "src/client.ts"
      to: "requestWithRetry"
      via: "protected request() wrapper"
      pattern: "protected async request"
---

<objective>
Change AgentOSClient.request() from private to protected so resource classes can access it.

Purpose: Per user decision, resource classes (AgentsResource, TeamsResource, etc.) need to call client.request() for all API operations. This requires changing the visibility from private to protected.

Output: AgentOSClient with protected request() method that handles both JSON and FormData bodies.
</objective>

<execution_context>
@/Users/adamshedivy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adamshedivy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-type-generation-and-first-resource/03-CONTEXT.md
@.planning/phases/03-type-generation-and-first-resource/03-01-SUMMARY.md

# Existing code to modify
@src/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Change request() from private to protected and handle FormData</name>
  <files>src/client.ts</files>
  <action>
**CRITICAL**: Per user decision, change the request() method visibility from private to protected so that resource classes can access it.

In src/client.ts, change:
```typescript
private async request<T>(
```
to:
```typescript
protected async request<T>(
```

Also update the method to handle FormData bodies by removing Content-Type header when body is FormData:
```typescript
protected async request<T>(
  method: RequestOptions["method"],
  path: string,
  options: Omit<RequestOptions, "method"> = {},
): Promise<T> {
  const url = `${this.baseUrl}${path}`;
  let headers = this.buildHeaders(options.headers);

  // Remove Content-Type for FormData - fetch auto-sets with boundary
  if (options.body instanceof FormData) {
    const { 'Content-Type': _, ...headersWithoutContentType } = headers;
    headers = headersWithoutContentType;
  }

  return requestWithRetry<T>(
    url,
    {
      method,
      headers,
      body: options.body,
      signal: options.signal,
    },
    this.maxRetries,
    this.timeout,
  );
}
```

This change:
1. Makes request() accessible to resource classes (AgentsResource, TeamsResource, etc.)
2. Handles FormData bodies correctly by removing Content-Type header
3. Maintains the same interface and behavior for non-FormData requests
  </action>
  <verify>
- src/client.ts has `protected async request` (not private)
- FormData detection and Content-Type removal is in place
- `npm run typecheck` passes
- Existing tests still pass
  </verify>
  <done>request() method is protected and handles FormData correctly</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for FormData handling in request()</name>
  <files>tests/client.test.ts</files>
  <action>
Add tests to verify the FormData Content-Type handling works correctly.

In tests/client.test.ts, add a describe block for the request method:

```typescript
describe('request() FormData handling', () => {
  it('removes Content-Type header when body is FormData', async () => {
    const fetchSpy = vi.spyOn(globalThis, 'fetch').mockResolvedValueOnce(
      new Response(JSON.stringify({ success: true }), { status: 200 })
    );

    const client = new AgentOSClient({
      baseUrl: 'https://api.example.com',
      apiKey: 'test-key',
    });

    // Access protected method via any cast for testing
    const formData = new FormData();
    formData.append('message', 'test');

    await (client as any).request('POST', '/test', { body: formData });

    const [, options] = fetchSpy.mock.calls[0];
    // Content-Type should NOT be set - fetch auto-sets for FormData
    expect(options.headers['Content-Type']).toBeUndefined();

    fetchSpy.mockRestore();
  });

  it('keeps Content-Type header for non-FormData bodies', async () => {
    const fetchSpy = vi.spyOn(globalThis, 'fetch').mockResolvedValueOnce(
      new Response(JSON.stringify({ success: true }), { status: 200 })
    );

    const client = new AgentOSClient({
      baseUrl: 'https://api.example.com',
    });

    await (client as any).request('POST', '/test', { body: '{"data": "test"}' });

    const [, options] = fetchSpy.mock.calls[0];
    expect(options.headers['Content-Type']).toBe('application/json');

    fetchSpy.mockRestore();
  });
});
```

Note: We use `(client as any).request` to access the protected method from tests. This is acceptable for testing protected methods.
  </action>
  <verify>
- tests/client.test.ts has FormData handling tests
- `npm test` passes
- Tests verify Content-Type removal for FormData
- Tests verify Content-Type preserved for non-FormData
  </verify>
  <done>FormData handling tests added and passing</done>
</task>

</tasks>

<verification>
1. src/client.ts has `protected async request` (grep for "protected async request")
2. FormData bodies trigger Content-Type header removal
3. Non-FormData requests keep Content-Type header
4. `npm run typecheck` passes
5. `npm test` passes
6. `npm run lint` passes
</verification>

<success_criteria>
- request() method visibility is protected
- FormData bodies handled correctly (Content-Type removed)
- All existing tests pass
- New FormData handling tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-type-generation-and-first-resource/03-03-SUMMARY.md`
</output>
