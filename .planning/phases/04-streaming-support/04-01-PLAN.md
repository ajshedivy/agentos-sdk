---
phase: 04-streaming-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/streaming/events.ts
  - src/streaming/parser.ts
  - src/streaming/index.ts
  - tests/streaming/events.test.ts
  - tests/streaming/parser.test.ts
autonomous: true

must_haves:
  truths:
    - "eventsource-parser package is installed and importable"
    - "Typed event interfaces exist for all SSE event types"
    - "SSE parser can transform Response body into typed events"
  artifacts:
    - path: "src/streaming/events.ts"
      provides: "Discriminated union types for streaming events"
      exports: ["AgentRunEvent", "RunStartedEvent", "RunContentEvent", "RunCompletedEvent", "MemoryUpdateStartedEvent", "MemoryUpdateCompletedEvent"]
    - path: "src/streaming/parser.ts"
      provides: "SSE parsing async generator"
      exports: ["parseSSEResponse"]
    - path: "src/streaming/index.ts"
      provides: "Public exports from streaming module"
      exports: ["*"]
  key_links:
    - from: "src/streaming/parser.ts"
      to: "eventsource-parser/stream"
      via: "import EventSourceParserStream"
      pattern: "EventSourceParserStream"
    - from: "src/streaming/parser.ts"
      to: "src/streaming/events.ts"
      via: "yields AgentRunEvent type"
      pattern: "AgentRunEvent"
---

<objective>
Set up SSE streaming infrastructure with eventsource-parser and typed event definitions.

Purpose: Provides the foundational types and parsing utilities that AgentStream class will consume.
Output: Event type definitions, SSE parser async generator, eventsource-parser dependency installed.
</objective>

<execution_context>
@/Users/adamshedivy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adamshedivy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-streaming-support/04-RESEARCH.md
@src/client.ts
@src/http.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install eventsource-parser and create event type definitions</name>
  <files>
    package.json
    src/streaming/events.ts
  </files>
  <action>
1. Install eventsource-parser package:
   ```bash
   npm install eventsource-parser
   ```

2. Create `src/streaming/events.ts` with discriminated union types for all streaming events.

**Event types from OpenAPI spec (verified in research):**
- RunStarted: Initial event with agent metadata
- RunContent: Content chunks during streaming
- RunCompleted: Final event with complete response and metrics
- MemoryUpdateStarted: Memory operation begins
- MemoryUpdateCompleted: Memory operation finishes

**Structure:**
```typescript
// Base event interface
interface BaseEvent {
  created_at: number;
  run_id: string;
}

// Individual event types with discriminant 'event' field
interface RunStartedEvent extends BaseEvent {
  event: 'RunStarted';
  session_id: string;
  agent_id: string;
  agent_name: string;
  model: string;
  model_provider: string;
}

interface RunContentEvent extends BaseEvent {
  event: 'RunContent';
  content: string;
  content_type: string;
}

interface RunCompletedEvent extends BaseEvent {
  event: 'RunCompleted';
  session_id: string;
  agent_id: string;
  agent_name: string;
  content: string;
  content_type: string;
  metrics?: {
    input_tokens: number;
    output_tokens: number;
    total_tokens: number;
    time_to_first_token?: number;
    duration?: number;
  };
}

interface MemoryUpdateStartedEvent extends BaseEvent {
  event: 'MemoryUpdateStarted';
}

interface MemoryUpdateCompletedEvent extends BaseEvent {
  event: 'MemoryUpdateCompleted';
}

// Discriminated union
type AgentRunEvent =
  | RunStartedEvent
  | RunContentEvent
  | RunCompletedEvent
  | MemoryUpdateStartedEvent
  | MemoryUpdateCompletedEvent;
```

Export all event interfaces and the union type.
  </action>
  <verify>
- `npm ls eventsource-parser` shows package installed
- `npx tsc --noEmit` passes with no errors
- All event types exported from events.ts
  </verify>
  <done>eventsource-parser installed, all streaming event types defined with discriminated union</done>
</task>

<task type="auto">
  <name>Task 2: Create SSE parser utility using eventsource-parser</name>
  <files>
    src/streaming/parser.ts
    src/streaming/index.ts
  </files>
  <action>
1. Create `src/streaming/parser.ts` with async generator for parsing SSE responses.

**Implementation using eventsource-parser (from research):**
```typescript
import { EventSourceParserStream } from 'eventsource-parser/stream';
import type { AgentRunEvent } from './events';

/**
 * Parse SSE response body into typed AgentRunEvent objects.
 *
 * Uses eventsource-parser for spec-compliant SSE parsing that handles:
 * - Chunked responses that split mid-message
 * - Multi-line data fields
 * - SSE comments and pings
 *
 * @param response - Fetch Response with SSE body
 * @param controller - AbortController for cancellation
 * @yields Typed AgentRunEvent objects
 *
 * @internal
 */
export async function* parseSSEResponse(
  response: Response,
  controller: AbortController
): AsyncGenerator<AgentRunEvent> {
  if (!response.body) {
    throw new Error('Response body is null');
  }

  const eventStream = response.body
    .pipeThrough(new TextDecoderStream())
    .pipeThrough(new EventSourceParserStream());

  try {
    for await (const event of eventStream) {
      // Check for abort before processing
      if (controller.signal.aborted) break;

      // Skip comments and pings (no data field)
      if (!event.data) continue;

      // Parse JSON data and add event type
      const data = JSON.parse(event.data);
      yield {
        event: event.event ?? 'message',
        ...data
      } as AgentRunEvent;
    }
  } finally {
    // Ensure controller is aborted on completion/error
    if (!controller.signal.aborted) {
      controller.abort();
    }
  }
}
```

2. Create `src/streaming/index.ts` to export all streaming module components:
```typescript
export * from './events';
export { parseSSEResponse } from './parser';
```
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Parser exports async generator function
- Index exports all streaming types and parser
  </verify>
  <done>SSE parser async generator created using eventsource-parser, barrel exports in place</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for event types and SSE parser</name>
  <files>
    tests/streaming/events.test.ts
    tests/streaming/parser.test.ts
  </files>
  <action>
1. Create `tests/streaming/events.test.ts` to verify type definitions:
   - Import and verify all event type exports
   - Test discriminated union narrowing with type guards
   - Verify event type inference in switch statements

2. Create `tests/streaming/parser.test.ts` to test SSE parsing:
   - Mock fetch Response with ReadableStream body
   - Test parsing single SSE event
   - Test parsing multiple events in sequence
   - Test handling of abort signal
   - Test error on null response body
   - Test skipping events without data field

**Test helper for creating mock SSE stream:**
```typescript
function createSSEStream(events: Array<{ event: string; data: object }>): ReadableStream<Uint8Array> {
  const encoder = new TextEncoder();
  const sseText = events
    .map(e => `event: ${e.event}\ndata: ${JSON.stringify(e.data)}\n\n`)
    .join('');

  return new ReadableStream({
    start(controller) {
      controller.enqueue(encoder.encode(sseText));
      controller.close();
    }
  });
}
```

**Test cases:**
- parseSSEResponse yields RunStartedEvent with correct shape
- parseSSEResponse yields multiple events in order
- parseSSEResponse respects abort signal
- parseSSEResponse throws on null body
- parseSSEResponse skips events without data field
  </action>
  <verify>
- `npm test tests/streaming` passes all tests
- Coverage includes happy path and edge cases
  </verify>
  <done>Event types and SSE parser have comprehensive test coverage</done>
</task>

</tasks>

<verification>
- `npm install` completes without errors
- `npm run build` succeeds
- `npm test` passes all tests including new streaming tests
- `npm run lint` passes
- eventsource-parser importable: `import { EventSourceParserStream } from 'eventsource-parser/stream'`
</verification>

<success_criteria>
1. eventsource-parser package installed and listed in dependencies
2. AgentRunEvent discriminated union type defined with 5 event variants
3. parseSSEResponse async generator yields typed events from Response body
4. Streaming module has barrel export (src/streaming/index.ts)
5. Tests cover event types and parser functionality
6. All builds and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-streaming-support/04-01-SUMMARY.md`
</output>
