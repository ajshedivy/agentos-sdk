# Phase 1: Project Setup & Foundation - Research

**Researched:** 2026-01-31
**Domain:** TypeScript package development with dual ESM/CJS distribution
**Confidence:** HIGH

## Summary

Phase 1 establishes the build and test infrastructure for a TypeScript SDK package with dual ESM/CommonJS distribution. The standard approach in 2026 uses **tsup** (esbuild-based bundler) for fast dual-format builds, **Vitest** for TypeScript-native testing, and careful **package.json exports** configuration to avoid the dual package hazard. TypeScript strict mode provides strong type safety guarantees essential for SDK development.

The research confirms that the chosen stack (tsup + Vitest + TypeScript strict) aligns with 2026 best practices for Node.js library development. Critical success factors include: proper package.json exports field configuration, validation with publint.dev and @arethetypeswrong/cli, and explicit file extension handling (.mjs for ESM, .cjs for CJS) to support older Node.js environments.

**Primary recommendation:** Configure package.json exports with conditional "import"/"require" fields, generate both .d.mts and .d.cts type declarations for proper TypeScript resolution, and validate the package with both publint and Are the Types Wrong before considering the phase complete.

## Standard Stack

The established libraries/tools for dual ESM/CJS TypeScript packages in 2026:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| tsup | 8.x | Build bundler | esbuild-based, zero-config dual format support, 10-25x faster than alternatives |
| TypeScript | 5.x | Type system | Strict mode essential for SDK reliability, declaration maps for source navigation |
| Vitest | 2.x | Test runner | Native ESM/TypeScript support, fast (Vite-powered), no transformation needed |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| publint | Latest | Package validation | Always - validates exports, type declarations, catches dual package hazards |
| @arethetypeswrong/cli | Latest | Type validation | Always - detects TypeScript type mismatches across module resolutions |
| Biome | 2.x | Linting/formatting | Optional - 20x faster than ESLint+Prettier, single tool, 423+ rules (as of v2.3) |
| ESLint | 9.x | Linting | Optional - mature ecosystem, extensive plugin support, slower than Biome |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| tsup | tsc + rollup | More control but complex config, slower builds, manual dual format setup |
| Vitest | Jest | Jest requires babel/ts-jest transformation, slower, CJS-focused |
| Biome | ESLint+Prettier | ESLint has broader plugin ecosystem but 20x slower, requires 2 tools |

**Installation:**
```bash
npm install -D tsup typescript vitest
npm install -D publint @arethetypeswrong/cli
npm install -D biome  # or eslint prettier
```

## Architecture Patterns

### Recommended Project Structure
```
agentos-sdk/
├── src/
│   ├── index.ts           # Main entry point, exports AgentOSClient
│   ├── client.ts          # AgentOSClient class
│   ├── errors.ts          # Typed error classes (NotFoundError, etc.)
│   └── types.ts           # Shared TypeScript types
├── tests/
│   ├── client.test.ts     # Mirror src/ structure
│   └── errors.test.ts
├── dist/                  # Generated by tsup
│   ├── index.js           # ESM output
│   ├── index.cjs          # CJS output
│   ├── index.d.ts         # Shared types (if possible)
│   ├── index.d.mts        # ESM type declarations
│   ├── index.d.cts        # CJS type declarations
│   ├── *.map              # Source maps
│   └── *.d.ts.map         # Declaration maps
├── tsup.config.ts
├── vitest.config.ts
├── tsconfig.json
└── package.json
```

### Pattern 1: Dual Format Build with tsup
**What:** Configure tsup to output both ESM (.js/.mjs) and CJS (.cjs) with proper TypeScript declarations
**When to use:** Always for Node.js libraries targeting multiple environments
**Example:**
```typescript
// Source: https://tsup.egoist.dev/ (documentation synthesis)
// tsup.config.ts
import { defineConfig } from 'tsup'

export default defineConfig({
  entry: ['src/index.ts'],
  format: ['esm', 'cjs'],
  dts: true,                    // Generate .d.ts files
  sourcemap: true,              // Generate .js.map files
  clean: true,                  // Clean dist/ before build
  splitting: false,             // Keep single entry point
  outExtension({ format }) {
    return {
      js: format === 'esm' ? '.js' : '.cjs'
    }
  }
})
```

### Pattern 2: Package.json Exports for Dual Package
**What:** Conditional exports that prevent dual package hazard
**When to use:** Always when publishing dual format packages
**Example:**
```json
// Source: https://nodejs.org/api/packages.html
{
  "name": "@ajshedivy/agentos-sdk",
  "version": "0.1.0",
  "type": "module",
  "main": "./dist/index.cjs",
  "module": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": {
        "types": "./dist/index.d.mts",
        "default": "./dist/index.js"
      },
      "require": {
        "types": "./dist/index.d.cts",
        "default": "./dist/index.cjs"
      }
    }
  },
  "files": [
    "dist"
  ],
  "engines": {
    "node": ">=18.0.0"
  }
}
```

### Pattern 3: TypeScript Strict Configuration
**What:** Enable all strict type checking options for SDK reliability
**When to use:** Always for libraries (especially SDKs where type safety is critical)
**Example:**
```json
// Source: https://www.typescriptlang.org/tsconfig/strict.html
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "lib": ["ES2022"],
    "moduleResolution": "bundler",

    // Strict mode (enables all strict checks)
    "strict": true,

    // Additional strict checks beyond "strict"
    "noUncheckedIndexedAccess": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "forceConsistentCasingInFileNames": true,

    // Declaration generation
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,

    // Output
    "outDir": "./dist",
    "rootDir": "./src",

    // Interop
    "esModuleInterop": true,
    "skipLibCheck": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "tests"]
}
```

### Pattern 4: Vitest Configuration for TypeScript
**What:** Zero-transform test setup with TypeScript support
**When to use:** Always for TypeScript packages
**Example:**
```typescript
// Source: https://vitest.dev/guide/
// vitest.config.ts
import { defineConfig } from 'vitest/config'

export default defineConfig({
  test: {
    globals: false,              // Explicit imports preferred for SDK
    environment: 'node',         // Node.js environment (not jsdom)
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'dist/**',
        'tests/**',
        '**/*.config.ts'
      ]
      // No thresholds - report only, don't fail builds
    }
  }
})
```

### Anti-Patterns to Avoid
- **Using "type": "commonjs" with dual exports:** Causes .js files to be treated as CJS, breaking ESM imports. Always use "type": "module" for dual packages.
- **Omitting file extensions in outExtension:** Node.js < 20 may fail to resolve modules without explicit .mjs/.cjs extensions.
- **Single .d.ts for both formats:** TypeScript 5.0+ requires .d.mts for ESM and .d.cts for CJS conditional exports.
- **Publishing without validation:** Dual package hazards are common and only caught by publint/@arethetypeswrong/cli.

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Dual format bundling | Custom tsc + rollup config | tsup with `format: ['esm', 'cjs']` | Handles extensions, sourcemaps, declarations, edge cases automatically |
| Package.json exports | Manual trial-and-error | publint.dev validation + Node.js examples repo | 30+ validation rules, catches dual package hazards you'll miss |
| TypeScript type resolution | Single .d.ts file | Conditional types (.d.mts/.d.cts) | Required for proper bundler/Node16 resolution since TS 5.0 |
| Test transforms | babel/ts-jest setup | Vitest native TypeScript | Zero config, 10x faster, no transform pipeline needed |
| Module format detection | File extension checking | Node.js "type" field + explicit extensions | Node.js native, prevents dual package hazard |

**Key insight:** Dual ESM/CJS packaging is deceptively complex. The Node.js module system has many edge cases (dual package hazard, conditional exports ordering, type resolution across formats). Established tools (tsup, publint) encode years of community learning about these edge cases.

## Common Pitfalls

### Pitfall 1: Dual Package Hazard
**What goes wrong:** Package gets loaded twice in the same runtime - once as ESM, once as CJS. Causes instanceof checks to fail, singleton state to duplicate, and mysterious bugs.
**Why it happens:** When package.json exports both formats without "default" fallback, some module systems load both. Example: ESM code does `import pkg from 'lib'` while CJS dependency does `require('lib')` - both versions load.
**How to avoid:**
- Always include "default" condition in exports
- Use "type": "module" in package.json
- Validate with publint (rule: EXPORTS_MODULE_SHOULD_BE_ESM)
**Warning signs:**
- publint error: "The module condition only works if the resolved file is ESM"
- Different instances of same class fail instanceof checks
- Singleton pattern creates multiple instances

### Pitfall 2: TypeScript Declaration Mismatch
**What goes wrong:** TypeScript can't resolve types correctly in ESM vs CJS contexts. IDE shows "Cannot find module" errors despite package working at runtime.
**Why it happens:** Since TypeScript 5.0, .d.ts files have format semantics. A .d.ts file is assumed to match adjacent .js file format. For dual packages, you need .d.mts (ESM) and .d.cts (CJS).
**How to avoid:**
- Use conditional types in package.json exports:
  ```json
  "import": { "types": "./dist/index.d.mts", "default": "./index.js" },
  "require": { "types": "./dist/index.d.cts", "default": "./index.cjs" }
  ```
- Configure tsup to generate both: `dts: true` handles this automatically
- Validate with @arethetypeswrong/cli
**Warning signs:**
- @arethetypeswrong/cli shows "Resolution failed" for node16 mode
- TypeScript errors in consuming projects despite correct runtime behavior
- Different type errors in bundler vs Node.js resolution

### Pitfall 3: Missing "type" Field
**What goes wrong:** Node.js 20.19.0+ spends extra time detecting module format, slowing startup. Package behavior varies between Node versions.
**Why it happens:** Without "type" field, Node.js must heuristically determine if .js files are ESM or CJS by parsing code.
**How to avoid:** Always set `"type": "module"` or `"type": "commonjs"` explicitly in package.json
**Warning signs:**
- publint warning: USE_TYPE - "Consider adding a 'type' field"
- Slower package import times on Node 20+
- Inconsistent behavior between Node.js versions

### Pitfall 4: Incorrect Conditional Export Ordering
**What goes wrong:** Wrong module format loaded in some environments. TypeScript types not found.
**Why it happens:** Conditional exports are order-sensitive. Node.js matches the FIRST condition that applies. "types" must come first, "default" must come last.
**How to avoid:**
```json
// CORRECT order:
{
  "exports": {
    ".": {
      "types": "./index.d.ts",      // FIRST: types for all contexts
      "import": "./index.js",        // Specific: ESM
      "require": "./index.cjs",      // Specific: CJS
      "default": "./index.js"        // LAST: fallback
    }
  }
}

// WRONG - types not found:
{
  "exports": {
    ".": {
      "import": "./index.js",
      "types": "./index.d.ts"  // TOO LATE - import already matched
    }
  }
}
```
**Warning signs:**
- publint errors: EXPORTS_TYPES_SHOULD_BE_FIRST, EXPORTS_DEFAULT_SHOULD_BE_LAST
- TypeScript can't find types despite .d.ts files existing
- Package works in some tools (webpack) but not others (vite)

### Pitfall 5: Publishing Test Files and Config
**What goes wrong:** Package tarball bloated with tests, fixtures, config files. Users download megabytes of irrelevant code.
**Why it happens:** By default, npm publishes everything not in .gitignore. Devs forget to use "files" field or .npmignore.
**How to avoid:**
- Use "files" whitelist in package.json: `"files": ["dist"]`
- Test with `npm pack` before publishing to inspect tarball contents
- publint validates with USE_FILES rule
**Warning signs:**
- Package size > 100KB for simple library
- `npm pack` output shows tests/, fixtures/, .config files
- Users report slow npm install times

### Pitfall 6: Node.js 18 End-of-Life
**What goes wrong:** Targeting Node.js 18 in 2026 means supporting a version discontinued on many platforms as of August 2025.
**Why it happens:** Documentation may be outdated, devs copy old examples.
**How to avoid:**
- User chose Node 18 as minimum in CONTEXT.md (locked decision)
- Document this as minimum supported version, not recommended
- Consider Node.js 20 (LTS until 2026-10) or 22 (LTS until 2027-04) for new projects
**Warning signs:**
- Platforms dropping Node 18 support in mid-2025
- Security updates discontinued

## Code Examples

Verified patterns from official sources:

### Complete Package.json Configuration
```json
{
  "name": "@ajshedivy/agentos-sdk",
  "version": "0.1.0",
  "description": "TypeScript SDK for AgentOS HTTP API",
  "type": "module",
  "main": "./dist/index.cjs",
  "module": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": {
        "types": "./dist/index.d.mts",
        "default": "./dist/index.js"
      },
      "require": {
        "types": "./dist/index.d.cts",
        "default": "./dist/index.cjs"
      }
    }
  },
  "files": [
    "dist",
    "README.md",
    "LICENSE"
  ],
  "scripts": {
    "build": "tsup",
    "test": "vitest run",
    "test:watch": "vitest",
    "test:coverage": "vitest run --coverage",
    "lint": "biome check .",
    "lint:fix": "biome check --write .",
    "validate": "npm run build && publint && attw --pack ."
  },
  "engines": {
    "node": ">=18.0.0"
  },
  "keywords": ["agentos", "sdk", "api-client"],
  "author": "Adam Shedivy",
  "license": "MIT",
  "repository": {
    "type": "git",
    "url": "git+https://github.com/ajshedivy/agentos-sdk.git"
  },
  "devDependencies": {
    "@arethetypeswrong/cli": "^0.17.0",
    "@biomejs/biome": "^1.9.4",
    "publint": "^0.2.12",
    "tsup": "^8.3.5",
    "typescript": "^5.7.2",
    "vitest": "^2.1.8"
  }
}
```
*Source: Synthesized from Node.js official docs and npm best practices*

### NPM Scripts for Validation
```bash
# Build and validate before publishing
npm run validate

# Breakdown:
npm run build              # tsup builds dual format
publint                    # Validates package.json exports, types
attw --pack .              # @arethetypeswrong/cli checks type resolution
```
*Source: https://github.com/arethetypeswrong/arethetypeswrong.github.io*

### Testing Package Locally
```bash
# Generate tarball (same as npm publish)
npm pack

# Inspect contents
tar -tzf ajshedivy-agentos-sdk-0.1.0.tgz

# Test in another project
cd /path/to/test-project
npm install /path/to/agentos-sdk/ajshedivy-agentos-sdk-0.1.0.tgz
```
*Source: https://docs.npmjs.com/cli/v11/configuring-npm/package-json/*

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Single .d.ts for all formats | .d.mts (ESM) + .d.cts (CJS) | TypeScript 5.0 (2023) | Proper type resolution in Node16/NodeNext mode |
| "module" field only | "exports" with conditions | Node.js 12+ (2020) | Prevents dual package hazard, explicit format control |
| Jest with ts-jest | Vitest with native TS | Vitest 1.0 (2023) | 10x faster, no transform config needed |
| Webpack/Rollup for bundling | tsup (esbuild) | tsup 6.0+ (2022) | 10-25x faster builds, zero config |
| ESLint + Prettier | Biome (optional) | Biome 1.0 (2023), 2.0 (2025) | 20x faster, single tool, though less mature ecosystem |
| Manual exports config | publint validation | publint 1.0 (2022) | Catches 30+ packaging mistakes automatically |

**Deprecated/outdated:**
- **"jsnext:main" field**: Replaced by "module" field (deprecated ~2018)
- **Implicit .js file format**: Node 20.19.0+ requires "type" field to avoid detection overhead
- **Single format packages**: CJS-only or ESM-only limits adoption; dual format is standard for libraries in 2026
- **.cjsx, .mjsx extensions**: Invalid, not supported by tooling; use .jsx with proper "type" field

## Open Questions

Things that couldn't be fully resolved:

1. **Browser testing setup timing**
   - What we know: Vitest supports browser mode (via Playwright/WebDriver)
   - What's unclear: Whether to configure in Phase 1 or defer to Phase 7 (browser compatibility)
   - Recommendation: Configure basic Node.js testing in Phase 1, defer browser testing to Phase 7 when browser compatibility is explicitly required. SDK is primarily Node.js-focused.

2. **Exact tsup declaration file strategy**
   - What we know: `dts: true` generates declarations, tsup uses API Extractor internally
   - What's unclear: Whether tsup automatically generates both .d.mts and .d.cts or requires explicit config
   - Recommendation: Start with `dts: true`, validate with @arethetypeswrong/cli, add explicit config if needed. Test with `npm pack` to inspect generated files.

3. **Pre-commit hooks configuration**
   - What we know: Popular tools are husky + lint-staged, or lefthook
   - What's unclear: User preference not stated in CONTEXT.md
   - Recommendation: Use lefthook (simpler, no npm install scripts) with hooks for: lint, type-check, test. Or defer to Phase 2 if not critical for foundation.

## Sources

### Primary (HIGH confidence)
- [Node.js Packages API Documentation](https://nodejs.org/api/packages.html) - Official dual package guidance, exports field structure, conditional exports
- [Vitest Getting Started Guide](https://vitest.dev/guide/) - Official installation, configuration, TypeScript integration
- [publint Rules](https://publint.dev/rules) - Package validation rules, dual format checks
- [TypeScript TSConfig Strict](https://www.typescriptlang.org/tsconfig/strict.html) - Official strict mode documentation

### Secondary (MEDIUM confidence)
- [Dual Publishing ESM and CJS with tsup](https://johnnyreilly.com/dual-publishing-esm-cjs-modules-with-tsup-and-are-the-types-wrong) - Verified pattern with Are the Types Wrong validation
- [TypeScript Declaration Maps](https://www.typescriptlang.org/tsconfig/declarationMap.html) - Official declarationMap documentation
- [Are the Types Wrong Repository](https://github.com/arethetypeswrong/arethetypeswrong.github.io) - Tool usage, problem detection
- [Ship ESM & CJS in one Package](https://antfu.me/posts/publish-esm-and-cjs) - Community best practices from core maintainer

### Tertiary (LOW confidence - WebSearch only)
- [Biome vs ESLint 2025 Comparison](https://medium.com/@harryespant/biome-vs-eslint-the-ultimate-2025-showdown-for-javascript-developers-speed-features-and-3e5130be4a3c) - Performance claims verified by multiple sources
- [Node.js 18 EOL Status](https://www.geeksforgeeks.org/node-js/how-to-define-the-required-node-js-version-in-package-json/) - Mentions August 2025 discontinuation
- [TypeScript Strict Mode Best Practices](https://dev.to/kovalevsky/how-to-configure-tsconfig-json-typescript-strict-options-4c1c) - Community recommendations

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - tsup, Vitest, TypeScript verified via official docs and Context7-equivalent authoritative sources
- Architecture: HIGH - package.json exports structure from Node.js official docs, tsup config from official documentation
- Pitfalls: MEDIUM - Dual package hazard well-documented (Node.js docs), type declaration issues verified (publint rules), but some edge cases from community sources only

**Research date:** 2026-01-31
**Valid until:** ~2026-03-31 (30 days - stable domain, but tooling versions update frequently)
**Next validation needed:** Before starting Phase 1 implementation, verify latest versions of tsup, Vitest, TypeScript, Biome
