---
phase: 07-runtime-support-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tests/runtime/node.test.ts
  - tests/runtime/browser-compat.test.ts
  - vitest.config.ts
autonomous: true

must_haves:
  truths:
    - "Test coverage can be measured and reported"
    - "Runtime-specific behaviors are tested"
    - "Browser-compatible code paths have test coverage"
  artifacts:
    - path: "tests/runtime/node.test.ts"
      provides: "Node.js 18+ runtime tests"
      min_lines: 40
    - path: "tests/runtime/browser-compat.test.ts"
      provides: "Browser compatibility tests"
      min_lines: 40
  key_links:
    - from: "vitest.config.ts"
      to: "tests/runtime/**"
      via: "test include pattern"
      pattern: "runtime.*\\.test\\.ts"
---

<objective>
Install test coverage tooling and add runtime compatibility tests for Node.js 18+ and browser-compatible code paths.

Purpose: Validate that SDK works correctly across supported runtimes and establish coverage baseline.
Output: Coverage tooling installed, runtime tests validating Node.js 18+ and browser-compatible features.
</objective>

<execution_context>
@/Users/adamshedivy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adamshedivy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-runtime-support-polish/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install coverage tooling and validate</name>
  <files>package.json, vitest.config.ts</files>
  <action>
    Install @vitest/coverage-v8 as dev dependency.

    Run `npm install --save-dev @vitest/coverage-v8` to add coverage provider.

    Verify coverage works by running `npm run test:coverage`.

    Update vitest.config.ts coverage section if needed to ensure proper exclusions:
    - Exclude dist/**, tests/**, **/*.config.ts, src/generated/**

    Document coverage baseline (capture approximate line/branch coverage percentages).
  </action>
  <verify>
    `npm run test:coverage` runs successfully and produces coverage report.
    Coverage percentages visible in terminal output.
  </verify>
  <done>
    @vitest/coverage-v8 installed, coverage report generates with baseline metrics captured.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Node.js 18+ runtime tests</name>
  <files>tests/runtime/node.test.ts</files>
  <action>
    Create tests/runtime/node.test.ts with tests validating Node.js 18+ specific behaviors:

    1. Native fetch API availability test
       - Verify `fetch` is available globally
       - Verify Response and Request constructors exist

    2. Native FormData availability test
       - Verify FormData constructor works
       - Verify FormData.append works with Blob
       - Verify FormData.get returns correct type

    3. ReadableStream and TextDecoderStream tests
       - Verify ReadableStream constructor exists
       - Verify TextDecoderStream is available for SSE parsing
       - Verify stream piping works

    4. AbortController and AbortSignal tests
       - Verify AbortController works
       - Verify AbortSignal.timeout() method exists (Node 18+)

    5. Buffer to Blob conversion test
       - Verify Buffer can be passed to Blob constructor
       - Verify resulting Blob has correct size

    Use `describe` blocks to organize by feature. Add JSDoc comments explaining Node.js 18+ specific behaviors being validated.
  </action>
  <verify>
    `npm test tests/runtime/node.test.ts` passes all tests.
    Tests verify Node.js 18+ native API availability.
  </verify>
  <done>
    Node.js 18+ runtime tests exist and pass, validating native fetch, FormData, streams, and abort APIs.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add browser compatibility tests</name>
  <files>tests/runtime/browser-compat.test.ts</files>
  <action>
    Create tests/runtime/browser-compat.test.ts testing browser-compatible code paths:

    1. File handling without Node.js fs module
       - Test normalizeFileInput with Buffer input (should work cross-platform)
       - Test normalizeFileInput with Blob input (should pass through)
       - Test normalizeFileInput with File input if available (Node 20+)

    2. SSE parsing with browser-native ReadableStream
       - Create ReadableStream with TextEncoder
       - Pass to parseSSEResponse
       - Verify events are parsed correctly
       - This validates the eventsource-parser works with browser-style streams

    3. FormData file upload simulation
       - Create FormData with Blob attachments (not ReadStream)
       - Verify FormData entries are correct
       - This validates browser upload path

    4. Response and Headers handling
       - Create Response with JSON body
       - Verify headers can be read
       - Verify json() method works
       - These are browser fetch APIs used throughout SDK

    5. Error handling with browser-compatible stack traces
       - Create SDK error classes
       - Verify stack traces are present
       - Verify instanceof checks work

    Note: These tests run in Node.js but validate code paths that would work in browsers.
    Do NOT use Node.js-only APIs (fs, path, ReadStream) in this test file.
  </action>
  <verify>
    `npm test tests/runtime/browser-compat.test.ts` passes all tests.
    No Node.js-specific imports (fs, path, crypto from 'crypto') in the test file.
  </verify>
  <done>
    Browser compatibility tests exist and pass, validating cross-platform code paths work correctly.
  </done>
</task>

</tasks>

<verification>
Run complete test suite to ensure new tests integrate properly:
- `npm test` - all 431+ tests pass
- `npm run test:coverage` - coverage report generates
- Tests organized in tests/runtime/ directory
</verification>

<success_criteria>
- @vitest/coverage-v8 installed and working
- Coverage baseline established
- Runtime tests validate Node.js 18+ native APIs
- Browser compatibility tests validate cross-platform code paths
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-runtime-support-polish/07-01-SUMMARY.md`
</output>
