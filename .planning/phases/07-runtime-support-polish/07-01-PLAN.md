---
phase: 07-runtime-support-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - vitest.config.ts
  - tests/runtime/node-compatibility.test.ts
autonomous: true

must_haves:
  truths:
    - "Test coverage is reported with line and branch percentages"
    - "Node.js 18+ compatibility tests pass"
    - "Runtime-specific feature detection tests exist"
  artifacts:
    - path: "vitest.config.ts"
      provides: "V8 coverage configuration"
      contains: "coverage"
    - path: "tests/runtime/node-compatibility.test.ts"
      provides: "Node.js runtime compatibility tests"
      min_lines: 50
  key_links:
    - from: "vitest.config.ts"
      to: "tests/runtime/"
      via: "coverage includes"
      pattern: "include.*runtime"
---

<objective>
Configure V8 coverage reporting and add Node.js runtime compatibility tests

Purpose: Validate SDK works correctly in Node.js 18+ environments with comprehensive coverage tracking
Output: Coverage configuration and runtime tests that verify Node.js-specific APIs function correctly
</objective>

<execution_context>
@/Users/adamshedivy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adamshedivy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-runtime-support-polish/07-CONTEXT.md
@.planning/phases/07-runtime-support-polish/07-RESEARCH.md

@package.json
@vitest.config.ts
@src/utils/files.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure V8 coverage in vitest.config.ts</name>
  <files>vitest.config.ts, package.json</files>
  <action>
Update vitest.config.ts to add V8 coverage configuration:

1. Add coverage configuration with provider: 'v8'
2. Configure reporters: ['text', 'json', 'html']
3. Set up include/exclude patterns:
   - Include: src/**/*.ts
   - Exclude: dist/**, tests/**, **/*.config.ts, **/*.d.ts, src/generated/**
4. Add reportsDirectory: './coverage'
5. Do NOT set coverage thresholds (per earlier decision - report only)

Update package.json if needed:
- Add @vitest/coverage-v8 as devDependency
- Verify test:coverage script uses --coverage flag (already present)

Note: V8 coverage provider is fast and accurate since Vitest 3.2.0 with AST-based remapping.
  </action>
  <verify>
Run `npm run test:coverage` - should output coverage report to console and generate coverage/ directory
  </verify>
  <done>
Coverage report shows line and branch percentages for src/ files, coverage/ directory contains HTML report
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Node.js runtime compatibility tests</name>
  <files>tests/runtime/node-compatibility.test.ts</files>
  <action>
Create tests/runtime/node-compatibility.test.ts with runtime compatibility tests:

1. Test native fetch API availability:
   - Verify fetch is defined and callable
   - Verify Response, Request, Headers constructors exist
   - Document that Node 18 fetch is experimental (stable in Node 21+)

2. Test FormData native support:
   - Verify FormData constructor exists
   - Test appending Blob to FormData
   - Test appending string values

3. Test ReadableStream support for SSE:
   - Verify ReadableStream constructor exists
   - Verify TextDecoderStream exists (used in SSE parsing)
   - Create a simple stream and verify async iteration works

4. Test Buffer <-> Blob conversion:
   - Verify Buffer.isBuffer works
   - Test Buffer to Blob conversion (used in file handling)

5. Test fs module availability:
   - Verify fs.createReadStream exists
   - Verify fs.readFile exists (for file input normalization)

6. Test AbortController/AbortSignal:
   - Verify AbortController constructor exists
   - Verify AbortSignal.timeout exists (Node 18+)

Each test should have clear documentation about which Node.js version introduced the feature.
  </action>
  <verify>
Run `npm run test tests/runtime/node-compatibility.test.ts` - all tests pass
  </verify>
  <done>
Runtime compatibility tests verify Node.js 18+ native APIs are available and functional
  </done>
</task>

</tasks>

<verification>
1. `npm run test:coverage` generates coverage report
2. `npm run test tests/runtime/` passes
3. Coverage report includes src/ files and excludes dist/, tests/, generated/
4. No new linting errors: `npm run lint`
</verification>

<success_criteria>
- V8 coverage configured and generates reports
- Runtime compatibility tests validate Node.js 18+ APIs
- All existing tests (431) continue passing
- Coverage report shows percentage for src/ code
</success_criteria>

<output>
After completion, create `.planning/phases/07-runtime-support-polish/07-01-SUMMARY.md`
</output>
