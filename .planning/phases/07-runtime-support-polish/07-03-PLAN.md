---
phase: 07-runtime-support-polish
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - .github/workflows/ci.yml
  - .github/workflows/publish.yml
autonomous: true

must_haves:
  truths:
    - "CI runs tests on push to main and pull requests"
    - "CI tests against Node.js 18, 20, and 22"
    - "CI generates coverage report in logs"
    - "Publishing happens on version tag push"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "Continuous integration pipeline"
      min_lines: 30
      contains: "node-version"
    - path: ".github/workflows/publish.yml"
      provides: "npm publish automation"
      min_lines: 20
      contains: "npm publish"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "package.json"
      via: "npm scripts"
      pattern: "npm run test"
    - from: ".github/workflows/publish.yml"
      to: "package.json"
      via: "npm publish"
      pattern: "npm publish"
---

<objective>
Create CI/CD pipeline for testing and npm publishing

Purpose: Automate testing across Node.js versions and publish to npm on version tags
Output: GitHub Actions workflows for CI (tests + coverage) and publishing (npm)
</objective>

<execution_context>
@/Users/adamshedivy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adamshedivy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-runtime-support-polish/07-CONTEXT.md
@.planning/phases/07-runtime-support-polish/07-RESEARCH.md
@.planning/phases/07-runtime-support-polish/07-01-SUMMARY.md

@package.json
@vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CI workflow for tests and coverage</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create .github/workflows/ci.yml with:

1. **Triggers** (from CONTEXT.md):
   - push: branches [main]
   - pull_request: branches [main]

2. **Jobs**:
   a. **lint** job:
      - runs-on: ubuntu-latest
      - Node.js 22 (latest LTS)
      - Steps: checkout, setup-node, npm ci, npm run lint, npm run typecheck

   b. **test** job:
      - runs-on: ubuntu-latest
      - strategy.matrix.node-version: [18, 20, 22]
      - Steps: checkout, setup-node with matrix version, npm ci, npm run test:coverage
      - Coverage report automatically printed to CI logs (no Codecov per CONTEXT.md)

   c. **validate** job:
      - runs-on: ubuntu-latest
      - Node.js 22
      - Steps: checkout, setup-node, npm ci, npm run validate (runs build + publint + attw)

3. **Configuration**:
   - Use actions/checkout@v4
   - Use actions/setup-node@v4
   - Use npm ci for reproducible installs
   - Add cache: 'npm' to setup-node for faster CI

4. **Job naming** (Claude's discretion):
   - lint: "Lint & Type Check"
   - test: "Test (Node ${{ matrix.node-version }})"
   - validate: "Validate Package"

Note: Coverage appears in CI logs from test:coverage script - no external service needed.
  </action>
  <verify>
File .github/workflows/ci.yml exists with valid YAML syntax:
`cat .github/workflows/ci.yml | head -50`
  </verify>
  <done>
CI workflow runs lint, tests on Node 18/20/22, and package validation on pushes and PRs to main
  </done>
</task>

<task type="auto">
  <name>Task 2: Create npm publish workflow</name>
  <files>.github/workflows/publish.yml</files>
  <action>
Create .github/workflows/publish.yml with:

1. **Trigger** (from CONTEXT.md):
   - push: tags: ['v*'] (e.g., v1.0.0, v1.2.3)

2. **Job: publish**:
   - runs-on: ubuntu-latest
   - Node.js 22
   - Steps:
     a. checkout
     b. setup-node with registry-url: 'https://registry.npmjs.org'
     c. npm ci
     d. npm run build
     e. npm run validate (ensure package is valid before publish)
     f. npm publish --access public
   - env: NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

3. **Best practices**:
   - Only publish from tags (not branches)
   - Run validation before publish
   - Use --access public for scoped package (@ajshedivy/agentos-sdk)

4. **Documentation** (add as comment in workflow):
   - To publish: git tag v1.0.0 && git push origin v1.0.0
   - NPM_TOKEN secret must be configured in repository settings
  </action>
  <verify>
File .github/workflows/publish.yml exists with valid YAML syntax:
`cat .github/workflows/publish.yml`
  </verify>
  <done>
Publish workflow triggers on version tags and publishes to npm with proper authentication
  </done>
</task>

<task type="auto">
  <name>Task 3: Add pre-publish validation script</name>
  <files>package.json</files>
  <action>
Add a prepublishOnly script to package.json that runs validation before any publish:

```json
"prepublishOnly": "npm run validate"
```

This ensures that even manual `npm publish` runs the full validation suite (build + publint + attw).

Also verify the package.json "files" field includes only necessary files:
- dist (build output)
- README.md (documentation)
- LICENSE (legal)

These are already configured correctly. This is a verification step.
  </action>
  <verify>
Run `npm run validate` and verify it completes successfully
  </verify>
  <done>
prepublishOnly hook ensures package is always validated before publish
  </done>
</task>

</tasks>

<verification>
1. .github/workflows/ci.yml exists with correct triggers and matrix
2. .github/workflows/publish.yml exists with version tag trigger
3. npm run validate passes locally
4. YAML files are syntactically valid
5. No hardcoded secrets in workflow files
</verification>

<success_criteria>
- CI workflow tests on Node.js 18, 20, 22
- CI triggers on push to main and PRs
- Coverage report generated in CI logs
- Publish workflow triggers on version tags (v*)
- prepublishOnly hook runs validation
- All workflow files use proper GitHub Actions syntax
</success_criteria>

<output>
After completion, create `.planning/phases/07-runtime-support-polish/07-03-SUMMARY.md`
</output>
