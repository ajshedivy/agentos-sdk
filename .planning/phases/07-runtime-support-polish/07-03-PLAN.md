---
phase: 07-runtime-support-polish
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - package.json
  - tests/integration/e2e.test.ts
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "Package can be packed and validated before publishing"
    - "CI pipeline validates builds, tests, and package configuration"
    - "Integration tests validate SDK can be used end-to-end"
  artifacts:
    - path: "package.json"
      provides: "Publishing scripts (prepublishOnly, pack:check)"
      contains: "prepublishOnly"
    - path: "tests/integration/e2e.test.ts"
      provides: "End-to-end SDK integration tests"
      min_lines: 50
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions CI pipeline"
      min_lines: 40
  key_links:
    - from: "package.json"
      to: "npm publish"
      via: "prepublishOnly hook"
      pattern: "prepublishOnly.*validate"
---

<objective>
Add npm publishing scripts, integration tests, and CI pipeline for release readiness.

Purpose: Ensure SDK is ready for npm publication with automated validation.
Output: Publishing scripts, e2e integration tests, and GitHub Actions CI pipeline.
</objective>

<execution_context>
@/Users/adamshedivy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adamshedivy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-runtime-support-polish/07-RESEARCH.md
@.planning/phases/07-runtime-support-polish/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add publishing scripts to package.json</name>
  <files>package.json</files>
  <action>
    Add npm publishing scripts to package.json:

    1. Add "prepublishOnly" script:
       ```
       "prepublishOnly": "npm run validate && npm run test"
       ```
       This runs before npm publish to ensure package is valid.

    2. Add "pack:check" script:
       ```
       "pack:check": "npm pack --dry-run 2>&1 | head -50"
       ```
       This previews package contents without creating tarball.

    3. Add "release:check" script:
       ```
       "release:check": "npm run build && npm run test && npm run validate && npm run pack:check"
       ```
       This is the full pre-release checklist in one command.

    4. Add "prepack" script:
       ```
       "prepack": "npm run build"
       ```
       Ensures build runs before packing.

    Keep existing scripts. Add new scripts in logical grouping.
    The validate script already exists: "npm run build && publint && attw --pack ."
  </action>
  <verify>
    `npm run pack:check` shows package contents (README.md, dist/, LICENSE).
    `npm run release:check` runs all validation steps without error.
  </verify>
  <done>
    Publishing scripts added to package.json. `npm run release:check` validates entire release pipeline.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add end-to-end integration tests</name>
  <files>tests/integration/e2e.test.ts</files>
  <action>
    Create tests/integration/e2e.test.ts with comprehensive integration tests.

    These tests validate the SDK works as a complete unit (not hitting real API, but testing all pieces together):

    1. **Client initialization tests**
       - Create client with all option combinations
       - Verify client properties are set correctly
       - Verify all resource namespaces are accessible

    2. **Request flow integration tests**
       - Mock fetch globally
       - Make agent.run() call through client
       - Verify request URL, headers, body are correct
       - Verify response is parsed correctly

    3. **Streaming integration tests**
       - Mock fetch to return SSE stream (using ReadableStream)
       - Call agents.runStream()
       - Verify stream yields correct event types
       - Verify stream can be aborted

    4. **Error handling integration tests**
       - Mock fetch to return 400/401/404/500 responses
       - Verify correct error types are thrown
       - Verify error includes response details

    5. **File upload integration tests**
       - Call agents.run() with media files
       - Verify FormData is constructed correctly
       - Verify Content-Type header is NOT set (for multipart boundary)

    6. **Resource method integration tests**
       - Test each resource has expected methods
       - Verify method signatures match expected types

    Use vi.stubGlobal('fetch', mockFetch) for fetch mocking.
    Organize with describe blocks per integration area.
  </action>
  <verify>
    `npm test tests/integration/e2e.test.ts` passes all tests.
    Tests cover client, resources, streaming, errors, and file uploads.
  </verify>
  <done>
    E2E integration tests validate SDK works as complete unit with mocked fetch.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create GitHub Actions CI pipeline</name>
  <files>.github/workflows/ci.yml</files>
  <action>
    Create .github/workflows/ci.yml with CI pipeline:

    ```yaml
    name: CI

    on:
      push:
        branches: [main]
      pull_request:
        branches: [main]

    jobs:
      build-and-test:
        runs-on: ubuntu-latest

        strategy:
          matrix:
            node-version: [18, 20, 22]

        steps:
          - uses: actions/checkout@v4

          - name: Use Node.js ${{ matrix.node-version }}
            uses: actions/setup-node@v4
            with:
              node-version: ${{ matrix.node-version }}
              cache: 'npm'

          - name: Install dependencies
            run: npm ci

          - name: Build
            run: npm run build

          - name: Type check
            run: npm run typecheck

          - name: Lint
            run: npm run lint

          - name: Test
            run: npm test

          - name: Validate package
            run: npm run validate

      coverage:
        runs-on: ubuntu-latest
        needs: build-and-test

        steps:
          - uses: actions/checkout@v4

          - name: Use Node.js 22
            uses: actions/setup-node@v4
            with:
              node-version: 22
              cache: 'npm'

          - name: Install dependencies
            run: npm ci

          - name: Run coverage
            run: npm run test:coverage

          # Optional: upload coverage to service
          # - name: Upload coverage
          #   uses: codecov/codecov-action@v4
    ```

    This pipeline:
    - Tests on Node.js 18, 20, and 22 (validates INFR-01)
    - Runs build, typecheck, lint, test, and validate
    - Runs coverage as separate job after tests pass
  </action>
  <verify>
    `.github/workflows/ci.yml` exists and is valid YAML.
    `cat .github/workflows/ci.yml` shows all expected steps.
  </verify>
  <done>
    GitHub Actions CI pipeline created. Will run on push/PR to main branch.
  </done>
</task>

</tasks>

<verification>
- `npm run release:check` runs successfully
- E2E integration tests pass
- CI pipeline file exists with correct structure
- Total test count increased from 431 baseline
</verification>

<success_criteria>
- Publishing scripts enable safe npm publish workflow
- E2E tests validate SDK as complete unit
- CI pipeline tests on Node.js 18, 20, 22
- Package ready for npm publication
</success_criteria>

<output>
After completion, create `.planning/phases/07-runtime-support-polish/07-03-SUMMARY.md`
</output>
