---
phase: 02-core-infrastructure
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/client.ts
  - src/index.ts
  - tests/client.test.ts
  - tests/index.test.ts
autonomous: true

must_haves:
  truths:
    - "Client can be instantiated with baseUrl and optional config"
    - "Client throws if baseUrl is missing"
    - "Client can retrieve OS configuration via getConfig()"
    - "Client can check health status via health()"
    - "Client sends Bearer token when apiKey is configured"
    - "All error classes and client are exported from index"
  artifacts:
    - path: "src/client.ts"
      provides: "AgentOSClient class implementation"
      exports: ["AgentOSClient"]
      min_lines: 60
    - path: "src/index.ts"
      provides: "Public API re-exports"
      exports: ["AgentOSClient", "APIError", "BadRequestError", "AuthenticationError", "NotFoundError", "VERSION"]
    - path: "tests/client.test.ts"
      provides: "Client integration tests"
      min_lines: 80
  key_links:
    - from: "src/client.ts"
      to: "src/http.ts"
      via: "requestWithRetry import"
      pattern: "import.*requestWithRetry.*from.*http"
    - from: "src/client.ts"
      to: "src/types.ts"
      via: "AgentOSClientOptions import"
      pattern: "import.*AgentOSClientOptions.*from.*types"
    - from: "src/index.ts"
      to: "src/client.ts"
      via: "AgentOSClient re-export"
      pattern: "export.*AgentOSClient.*from.*client"
---

<objective>
Implement the AgentOSClient class with configuration, authentication, and core API methods.

Purpose: Delivers the main client class that developers will use. Supports getConfig() and health() methods to validate the infrastructure works end-to-end before adding more complex resources in Phase 3.

Output:
- src/client.ts with AgentOSClient class
- Updated src/index.ts with complete public API exports
- tests/client.test.ts with comprehensive client tests
</objective>

<execution_context>
@/Users/adamshedivy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adamshedivy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-infrastructure/02-RESEARCH.md

# Dependencies from prior plans
@src/http.ts
@src/errors.ts
@src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement AgentOSClient class</name>
  <files>src/client.ts, tests/client.test.ts</files>
  <action>
Create src/client.ts with the AgentOSClient class:

```typescript
import { requestWithRetry } from './http';
import type { AgentOSClientOptions, OSConfig, HealthStatus, RequestOptions } from './types';

/**
 * AgentOS API client
 *
 * @example
 * ```typescript
 * const client = new AgentOSClient({
 *   baseUrl: 'https://api.agentos.example.com',
 *   apiKey: 'your-api-key',
 * });
 *
 * const config = await client.getConfig();
 * const health = await client.health();
 * ```
 */
export class AgentOSClient {
  readonly version = '0.1.0';

  private readonly baseUrl: string;
  private readonly apiKey?: string;
  private readonly timeout: number;
  private readonly maxRetries: number;
  private readonly defaultHeaders: Record<string, string>;

  constructor(options: AgentOSClientOptions) {
    if (!options.baseUrl) {
      throw new Error('baseUrl is required');
    }

    // Remove trailing slash for consistent URL joining
    this.baseUrl = options.baseUrl.replace(/\/$/, '');
    this.apiKey = options.apiKey;
    this.timeout = options.timeout ?? 30000;
    this.maxRetries = options.maxRetries ?? 2;
    this.defaultHeaders = {
      'Content-Type': 'application/json',
      'User-Agent': `agentos-sdk/${this.version}`,
      ...options.headers,
    };
  }

  /**
   * Get OS configuration
   */
  async getConfig(): Promise<OSConfig> {
    return this.request<OSConfig>('GET', '/config');
  }

  /**
   * Check API health status
   */
  async health(): Promise<HealthStatus> {
    return this.request<HealthStatus>('GET', '/health');
  }

  /**
   * Make an authenticated request to the API
   */
  private async request<T>(
    method: RequestOptions['method'],
    path: string,
    options: Omit<RequestOptions, 'method'> = {}
  ): Promise<T> {
    const url = `${this.baseUrl}${path}`;
    const headers = this.buildHeaders(options.headers);

    return requestWithRetry<T>(
      url,
      {
        method,
        headers,
        body: options.body,
        signal: options.signal,
      },
      this.maxRetries,
      this.timeout
    );
  }

  /**
   * Build request headers with authentication
   */
  private buildHeaders(overrideHeaders?: Record<string, string>): Record<string, string> {
    const headers = { ...this.defaultHeaders };

    // Add Bearer token if API key is configured
    if (this.apiKey) {
      headers['Authorization'] = `Bearer ${this.apiKey}`;
    }

    // Apply per-request header overrides
    if (overrideHeaders) {
      Object.assign(headers, overrideHeaders);
    }

    return headers;
  }
}
```

Create tests/client.test.ts:

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { AgentOSClient } from '../src/client';
import { AuthenticationError, NotFoundError } from '../src/errors';

// Mock the http module
vi.mock('../src/http', () => ({
  requestWithRetry: vi.fn(),
}));

import { requestWithRetry } from '../src/http';

const mockRequestWithRetry = vi.mocked(requestWithRetry);

describe('AgentOSClient', () => {
  beforeEach(() => {
    mockRequestWithRetry.mockReset();
  });

  describe('constructor', () => {
    it('should require baseUrl', () => {
      expect(() => new AgentOSClient({} as any)).toThrow('baseUrl is required');
      expect(() => new AgentOSClient({ baseUrl: '' })).toThrow('baseUrl is required');
    });

    it('should accept valid options', () => {
      const client = new AgentOSClient({
        baseUrl: 'https://api.example.com',
        apiKey: 'test-key',
        timeout: 5000,
        maxRetries: 3,
      });

      expect(client.version).toBe('0.1.0');
    });

    it('should remove trailing slash from baseUrl', () => {
      const client = new AgentOSClient({
        baseUrl: 'https://api.example.com/',
      });

      // Verify by making a request and checking the URL
      mockRequestWithRetry.mockResolvedValueOnce({ status: 'healthy' });
      client.health();

      expect(mockRequestWithRetry).toHaveBeenCalledWith(
        'https://api.example.com/health',
        expect.any(Object),
        expect.any(Number),
        expect.any(Number)
      );
    });
  });

  describe('getConfig', () => {
    it('should fetch config from /config endpoint', async () => {
      const mockConfig = {
        version: '1.0.0',
        environment: 'production',
        features: { streaming: true },
      };
      mockRequestWithRetry.mockResolvedValueOnce(mockConfig);

      const client = new AgentOSClient({
        baseUrl: 'https://api.example.com',
      });

      const config = await client.getConfig();

      expect(config).toEqual(mockConfig);
      expect(mockRequestWithRetry).toHaveBeenCalledWith(
        'https://api.example.com/config',
        expect.objectContaining({ method: 'GET' }),
        2, // default maxRetries
        30000 // default timeout
      );
    });
  });

  describe('health', () => {
    it('should fetch health from /health endpoint', async () => {
      const mockHealth = {
        status: 'healthy',
        timestamp: '2026-01-31T00:00:00Z',
      };
      mockRequestWithRetry.mockResolvedValueOnce(mockHealth);

      const client = new AgentOSClient({
        baseUrl: 'https://api.example.com',
      });

      const health = await client.health();

      expect(health).toEqual(mockHealth);
    });
  });

  describe('authentication', () => {
    it('should include Bearer token when apiKey is set', async () => {
      mockRequestWithRetry.mockResolvedValueOnce({ status: 'healthy' });

      const client = new AgentOSClient({
        baseUrl: 'https://api.example.com',
        apiKey: 'my-secret-key',
      });

      await client.health();

      expect(mockRequestWithRetry).toHaveBeenCalledWith(
        expect.any(String),
        expect.objectContaining({
          headers: expect.objectContaining({
            'Authorization': 'Bearer my-secret-key',
          }),
        }),
        expect.any(Number),
        expect.any(Number)
      );
    });

    it('should not include Authorization header when apiKey is not set', async () => {
      mockRequestWithRetry.mockResolvedValueOnce({ status: 'healthy' });

      const client = new AgentOSClient({
        baseUrl: 'https://api.example.com',
      });

      await client.health();

      const call = mockRequestWithRetry.mock.calls[0];
      const headers = call?.[1]?.headers as Record<string, string>;
      expect(headers['Authorization']).toBeUndefined();
    });
  });

  describe('custom options', () => {
    it('should use custom timeout', async () => {
      mockRequestWithRetry.mockResolvedValueOnce({ status: 'healthy' });

      const client = new AgentOSClient({
        baseUrl: 'https://api.example.com',
        timeout: 5000,
      });

      await client.health();

      expect(mockRequestWithRetry).toHaveBeenCalledWith(
        expect.any(String),
        expect.any(Object),
        2,
        5000 // custom timeout
      );
    });

    it('should use custom maxRetries', async () => {
      mockRequestWithRetry.mockResolvedValueOnce({ status: 'healthy' });

      const client = new AgentOSClient({
        baseUrl: 'https://api.example.com',
        maxRetries: 5,
      });

      await client.health();

      expect(mockRequestWithRetry).toHaveBeenCalledWith(
        expect.any(String),
        expect.any(Object),
        5, // custom maxRetries
        30000
      );
    });

    it('should include custom headers', async () => {
      mockRequestWithRetry.mockResolvedValueOnce({ status: 'healthy' });

      const client = new AgentOSClient({
        baseUrl: 'https://api.example.com',
        headers: { 'X-Custom-Header': 'custom-value' },
      });

      await client.health();

      expect(mockRequestWithRetry).toHaveBeenCalledWith(
        expect.any(String),
        expect.objectContaining({
          headers: expect.objectContaining({
            'X-Custom-Header': 'custom-value',
          }),
        }),
        expect.any(Number),
        expect.any(Number)
      );
    });
  });

  describe('error handling', () => {
    it('should propagate errors from requestWithRetry', async () => {
      mockRequestWithRetry.mockRejectedValueOnce(
        new AuthenticationError('Invalid API key', 'req-123')
      );

      const client = new AgentOSClient({
        baseUrl: 'https://api.example.com',
        apiKey: 'invalid-key',
      });

      await expect(client.health()).rejects.toThrow(AuthenticationError);
    });
  });
});
```
  </action>
  <verify>Run `npm run test` - all client tests pass. Run `npm run typecheck` - no errors.</verify>
  <done>client.ts exports AgentOSClient with getConfig() and health() methods. Tests verify construction, auth, and API calls.</done>
</task>

<task type="auto">
  <name>Task 2: Update index.ts with complete public API</name>
  <files>src/index.ts, tests/index.test.ts</files>
  <action>
Update src/index.ts to export the complete public API:

```typescript
/**
 * AgentOS TypeScript SDK
 *
 * @packageDocumentation
 */

// Version
export const VERSION = '0.1.0';

// Client
export { AgentOSClient } from './client';

// Types
export type {
  AgentOSClientOptions,
  RequestOptions,
  OSConfig,
  HealthStatus,
} from './types';

// Errors
export {
  APIError,
  BadRequestError,
  AuthenticationError,
  NotFoundError,
  UnprocessableEntityError,
  RateLimitError,
  InternalServerError,
  RemoteServerUnavailableError,
} from './errors';
```

Update tests/index.test.ts to verify all exports:

```typescript
import { describe, it, expect } from 'vitest';
import {
  VERSION,
  AgentOSClient,
  APIError,
  BadRequestError,
  AuthenticationError,
  NotFoundError,
  UnprocessableEntityError,
  RateLimitError,
  InternalServerError,
  RemoteServerUnavailableError,
} from '../src/index';

describe('Package Exports', () => {
  it('should export VERSION', () => {
    expect(VERSION).toBe('0.1.0');
  });

  it('should export AgentOSClient', () => {
    expect(AgentOSClient).toBeDefined();
    expect(typeof AgentOSClient).toBe('function');
  });

  it('should export all error classes', () => {
    expect(APIError).toBeDefined();
    expect(BadRequestError).toBeDefined();
    expect(AuthenticationError).toBeDefined();
    expect(NotFoundError).toBeDefined();
    expect(UnprocessableEntityError).toBeDefined();
    expect(RateLimitError).toBeDefined();
    expect(InternalServerError).toBeDefined();
    expect(RemoteServerUnavailableError).toBeDefined();
  });

  it('should allow instantiation of AgentOSClient', () => {
    const client = new AgentOSClient({
      baseUrl: 'https://api.example.com',
    });
    expect(client.version).toBe('0.1.0');
  });

  it('should allow error class inheritance checks', () => {
    const error = new BadRequestError('test');
    expect(error instanceof BadRequestError).toBe(true);
    expect(error instanceof APIError).toBe(true);
    expect(error instanceof Error).toBe(true);
  });
});
```

This update:
1. Exports the real AgentOSClient (replaces placeholder)
2. Exports all type interfaces for TypeScript consumers
3. Exports all error classes for catch blocks
4. Maintains VERSION export for compatibility
  </action>
  <verify>Run `npm run build && npm run test && npm run validate` - all pass. Verify exports are correct for both ESM and CJS.</verify>
  <done>index.ts exports AgentOSClient, all error classes, types, and VERSION. Package validates with publint and attw.</done>
</task>

</tasks>

<verification>
Run the complete validation pipeline:

```bash
npm run build && npm run test && npm run lint && npm run typecheck && npm run validate
```

All commands should pass. Additionally, verify runtime imports:

```bash
# ESM import test
node --input-type=module -e "import { AgentOSClient, BadRequestError } from './dist/index.js'; console.log(new AgentOSClient({ baseUrl: 'http://test' }).version)"

# CJS require test
node -e "const { AgentOSClient, BadRequestError } = require('./dist/index.cjs'); console.log(new AgentOSClient({ baseUrl: 'http://test' }).version)"
```

Both should output `0.1.0`.
</verification>

<success_criteria>
- [ ] src/client.ts exists with AgentOSClient class
- [ ] AgentOSClient has getConfig() and health() methods
- [ ] AgentOSClient supports Bearer token authentication
- [ ] src/index.ts exports AgentOSClient, errors, and types
- [ ] tests/client.test.ts verifies all client functionality
- [ ] tests/index.test.ts verifies all exports
- [ ] `npm run test` passes with all tests green
- [ ] `npm run build` passes
- [ ] `npm run validate` passes (publint + attw)
- [ ] ESM and CJS imports work at runtime
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-infrastructure/02-03-SUMMARY.md`
</output>
