---
phase: 06-file-uploads-and-knowledge
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/resources/agents.ts
  - src/resources/teams.ts
  - src/resources/workflows.ts
  - tests/resources/agents.test.ts
  - tests/resources/teams.test.ts
  - tests/resources/workflows.test.ts
autonomous: true

must_haves:
  truths:
    - "agents.run() and agents.runStream() accept images, audio, videos, files arrays"
    - "teams.run() and teams.runStream() accept images, audio, videos, files arrays"
    - "workflows.run() and workflows.runStream() accept images, audio, videos, files arrays"
    - "Media files are appended to FormData using normalizeFileInput"
    - "Multiple files in an array are appended with same field name (images, audio, etc.)"
  artifacts:
    - path: "src/resources/agents.ts"
      provides: "AgentsResource with media support"
      contains: "images.*audio.*videos.*files"
    - path: "src/resources/teams.ts"
      provides: "TeamsResource with media support"
      contains: "images.*audio.*videos.*files"
    - path: "src/resources/workflows.ts"
      provides: "WorkflowsResource with media support"
      contains: "images.*audio.*videos.*files"
  key_links:
    - from: "src/resources/agents.ts"
      to: "src/utils/files.ts"
      via: "normalizeFileInput import"
      pattern: "import.*normalizeFileInput.*from.*utils/files"
    - from: "src/resources/teams.ts"
      to: "src/utils/files.ts"
      via: "normalizeFileInput import"
      pattern: "import.*normalizeFileInput.*from.*utils/files"
---

<objective>
Extend run methods on agents, teams, and workflows resources to accept media file inputs (images, audio, videos, files).

Purpose: Enable developers to send multimodal content (images, audio, video, files) with agent runs, fulfilling requirements FILE-01 through FILE-05.

Output: Updated RunOptions and StreamRunOptions interfaces with optional media arrays, and updated run/runStream methods that append media to FormData.
</objective>

<execution_context>
@/Users/adamshedivy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adamshedivy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-file-uploads-and-knowledge/06-RESEARCH.md
@.planning/phases/06-file-uploads-and-knowledge/06-01-SUMMARY.md

Reference files:
@src/resources/agents.ts (current implementation)
@src/resources/teams.ts (current implementation)
@src/resources/workflows.ts (current implementation)
@src/types/files.ts (file input types from 06-01)
@src/utils/files.ts (normalizeFileInput from 06-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend AgentsResource with media support</name>
  <files>src/resources/agents.ts, tests/resources/agents.test.ts</files>
  <action>
Update src/resources/agents.ts to support media file inputs:

1. Add import for file types and normalizer:
```typescript
import type { Image, Audio, Video, FileType } from '../types/files';
import { normalizeFileInput } from '../utils/files';
```

2. Update RunOptions interface to include media arrays:
```typescript
export interface RunOptions {
  /** The message to send to the agent */
  message: string;
  /** Optional session ID for conversation continuity */
  sessionId?: string;
  /** Optional user ID for user context */
  userId?: string;
  /** Image files to include with the request */
  images?: Image[];
  /** Audio files to include with the request */
  audio?: Audio[];
  /** Video files to include with the request */
  videos?: Video[];
  /** Generic files to include with the request */
  files?: FileType[];
  /** Streaming mode (only non-streaming supported) */
  stream?: false;
}
```

3. Update StreamRunOptions similarly:
```typescript
export interface StreamRunOptions {
  /** The message to send to the agent */
  message: string;
  /** Optional session ID for conversation continuity */
  sessionId?: string;
  /** Optional user ID for user context */
  userId?: string;
  /** Image files to include with the request */
  images?: Image[];
  /** Audio files to include with the request */
  audio?: Audio[];
  /** Video files to include with the request */
  videos?: Video[];
  /** Generic files to include with the request */
  files?: FileType[];
}
```

4. Update run() method to append media files:
```typescript
async run(agentId: string, options: RunOptions): Promise<unknown> {
  const formData = new FormData();
  formData.append("message", options.message);
  formData.append("stream", "false");

  if (options.sessionId) formData.append("session_id", options.sessionId);
  if (options.userId) formData.append("user_id", options.userId);

  // Append media files
  if (options.images) {
    for (const image of options.images) {
      formData.append("images", normalizeFileInput(image));
    }
  }
  if (options.audio) {
    for (const audio of options.audio) {
      formData.append("audio", normalizeFileInput(audio));
    }
  }
  if (options.videos) {
    for (const video of options.videos) {
      formData.append("videos", normalizeFileInput(video));
    }
  }
  if (options.files) {
    for (const file of options.files) {
      formData.append("files", normalizeFileInput(file));
    }
  }

  return this.client.request<unknown>(
    "POST",
    `/agents/${encodeURIComponent(agentId)}/runs`,
    { body: formData },
  );
}
```

5. Update runStream() similarly with media file appending.

6. Add tests in tests/resources/agents.test.ts:
```typescript
describe('run with media files', () => {
  it('appends images to FormData', async () => {
    const mockFetch = vi.fn().mockResolvedValue({
      ok: true,
      json: () => Promise.resolve({ content: 'response' }),
    });
    vi.stubGlobal('fetch', mockFetch);

    const client = new AgentOSClient({ baseUrl: 'https://api.example.com' });
    const imageBuffer = Buffer.from('fake-image-data');

    await client.agents.run('agent-1', {
      message: 'Describe this image',
      images: [imageBuffer],
    });

    const [url, fetchOptions] = mockFetch.mock.calls[0];
    const body = fetchOptions.body as FormData;
    expect(body.get('message')).toBe('Describe this image');
    // FormData.getAll returns all values for a key
    const images = body.getAll('images');
    expect(images.length).toBe(1);
  });

  it('appends multiple files of each type', async () => {
    const mockFetch = vi.fn().mockResolvedValue({
      ok: true,
      json: () => Promise.resolve({ content: 'response' }),
    });
    vi.stubGlobal('fetch', mockFetch);

    const client = new AgentOSClient({ baseUrl: 'https://api.example.com' });
    const buffer1 = Buffer.from('image-1');
    const buffer2 = Buffer.from('image-2');
    const audioBuffer = Buffer.from('audio-data');

    await client.agents.run('agent-1', {
      message: 'Process these',
      images: [buffer1, buffer2],
      audio: [audioBuffer],
    });

    const body = mockFetch.mock.calls[0][1].body as FormData;
    expect(body.getAll('images').length).toBe(2);
    expect(body.getAll('audio').length).toBe(1);
  });
});
```
  </action>
  <verify>
Run `npm test -- tests/resources/agents.test.ts` and `npx tsc --noEmit` to verify agents resource works with media files.
  </verify>
  <done>AgentsResource run() and runStream() methods accept and append images, audio, videos, and files arrays to FormData.</done>
</task>

<task type="auto">
  <name>Task 2: Extend TeamsResource with media support</name>
  <files>src/resources/teams.ts, tests/resources/teams.test.ts</files>
  <action>
Update src/resources/teams.ts following the same pattern as agents:

1. Add imports for file types and normalizer at top of file.

2. Update TeamRunOptions and TeamStreamRunOptions interfaces to include media arrays:
```typescript
export interface TeamRunOptions {
  message: string;
  sessionId?: string;
  userId?: string;
  images?: Image[];
  audio?: Audio[];
  videos?: Video[];
  files?: FileType[];
  stream?: false;
}

export interface TeamStreamRunOptions {
  message: string;
  sessionId?: string;
  userId?: string;
  images?: Image[];
  audio?: Audio[];
  videos?: Video[];
  files?: FileType[];
}
```

3. Update run() and runStream() methods to append media files using the same pattern from agents.ts.

4. Add tests for media support in tests/resources/teams.test.ts (following same pattern as agents tests).
  </action>
  <verify>
Run `npm test -- tests/resources/teams.test.ts` to verify teams resource media support.
  </verify>
  <done>TeamsResource run() and runStream() methods accept and append images, audio, videos, and files arrays to FormData.</done>
</task>

<task type="auto">
  <name>Task 3: Extend WorkflowsResource with media support</name>
  <files>src/resources/workflows.ts, tests/resources/workflows.test.ts</files>
  <action>
Update src/resources/workflows.ts following the same pattern as agents and teams:

1. Add imports for file types and normalizer at top of file.

2. Update WorkflowRunOptions and WorkflowStreamRunOptions interfaces to include media arrays:
```typescript
export interface WorkflowRunOptions {
  message: string;
  sessionId?: string;
  userId?: string;
  images?: Image[];
  audio?: Audio[];
  videos?: Video[];
  files?: FileType[];
  stream?: false;
}

export interface WorkflowStreamRunOptions {
  message: string;
  sessionId?: string;
  userId?: string;
  images?: Image[];
  audio?: Audio[];
  videos?: Video[];
  files?: FileType[];
}
```

3. Update run() and runStream() methods to append media files using the same pattern.

4. Add tests for media support in tests/resources/workflows.test.ts.
  </action>
  <verify>
Run `npm test -- tests/resources/workflows.test.ts` to verify workflows resource media support.
  </verify>
  <done>WorkflowsResource run() and runStream() methods accept and append images, audio, videos, and files arrays to FormData.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. All resource tests pass: `npm test -- tests/resources`
3. Run options include media file arrays in all three resources
4. FormData correctly appends multiple files with same field name
</verification>

<success_criteria>
- RunOptions and StreamRunOptions include images, audio, videos, files arrays in all resources
- run() and runStream() methods use normalizeFileInput to convert inputs before FormData.append()
- Multiple files in an array are all appended with the same field name (e.g., multiple images all as 'images')
- Tests verify FormData contains expected media file entries
</success_criteria>

<output>
After completion, create `.planning/phases/06-file-uploads-and-knowledge/06-02-SUMMARY.md`
</output>
